---
title: "Determination Rates Benchmark Report"
subtitle: "PNADCperiods Package Performance Analysis"
author: "PNADCperiods Package"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: show
vignette: >
  %\VignetteIndexEntry{Determination Rates Benchmark Report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
```

# Executive Summary

This document presents comprehensive benchmark results for the PNADCperiods package,
tested on complete PNADC quarterly data from 2012 to 2025 (55 quarters, 28.4 million
individual observations, 9.6 million unique household-quarter combinations).

## Key Results

| Metric | Value |
|--------|-------|
| **Total rows processed** | 28,395,273 |
| **Unique household-quarters** | 9,598,723 |
| **Month determination rate** | 96.69% |
| **Fortnight determination rate** | 7.64% |
| **Week determination rate** | 1.54% |
| **Processing time** | 160.2 seconds |
| **Throughput** | 177,303 rows/sec |

## Experimental Strategies Summary

| Strategy | Fortnight % | Week % | Execution Time |
|----------|-------------|--------|----------------|
| Strict (baseline) | 7.64% | 1.54% | - |
| + Probabilistic | 13.61% | 1.82% | ~220s |
| + UPA Aggregation | 57.69% | 14.36% | ~15s |
| + Both | **60.33%** | **14.60%** | ~235s |

**Key finding:** UPA homogeneity rate = **100%** for both fortnights and weeks.

---

# Data Description

## Source

- **Dataset**: PNADC (Pesquisa Nacional por Amostra de Domicilios Continua)
- **Source**: IBGE (Brazilian Institute of Geography and Statistics)
- **Type**: Quarterly household survey microdata
- **Format**: FST files (fast serialization)

## Coverage

| Dimension | Value |
|-----------|-------|
| Years | 2012-2025 |
| Quarters | 55 |
| Total observations | 28,395,273 |
| Unique households per quarter | ~175,000 |
| Unique UPAs (Primary Sampling Units) | ~3,500 per quarter |

## Variables Used

The following variables are required for period identification:

| Variable | Description | Used For |
|----------|-------------|----------|
| `Ano` | Survey year | Period calculation |
| `Trimestre` | Quarter (1-4) | Period calculation |
| `UPA` | Primary Sampling Unit | Cross-quarter aggregation |
| `V1008` | Household sequence within UPA | Household identification |
| `V1014` | Panel identifier | Cross-quarter aggregation |
| `V2008` | Birth day (1-31) | Birthday constraint |
| `V20081` | Birth month (1-12) | Birthday constraint |
| `V20082` | Birth year | Birthday constraint |
| `V2009` | Age | Birthday constraint validation |

---

# Functions Tested

## `pnadc_identify_periods()`

The main function for building the reference period crosswalk.

### Function Signature

```{r}
pnadc_identify_periods(
  data,
  verbose = TRUE
)
```

### Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `data` | data.frame/data.table | (required) | PNADC microdata with required columns |
| `verbose` | logical | TRUE | Display progress information |

### Return Value

A `data.table` crosswalk with the following columns:

| Column | Type | Description |
|--------|------|-------------|
| `Ano` | integer | Survey year |
| `Trimestre` | integer | Quarter (1-4) |
| `UPA` | character | Primary Sampling Unit |
| `V1008` | integer | Household sequence |
| `V1014` | integer | Panel identifier |
| `ref_month` | Date | Reference month (1st of month) |
| `ref_month_in_quarter` | integer | Month position in quarter (1-3) |
| `ref_month_yyyymm` | integer | Month in YYYYMM format |
| `determined_month` | logical | TRUE if month was determined |
| `ref_fortnight` | Date | Reference fortnight (1st or 16th) |
| `ref_fortnight_in_quarter` | integer | Fortnight position (1-6) |
| `ref_fortnight_yyyyff` | integer | Fortnight in YYYYFF format |
| `determined_fortnight` | logical | TRUE if fortnight was determined |
| `ref_week` | Date | Reference week start (Monday) |
| `ref_week_in_quarter` | integer | Week position (1-13/14) |
| `ref_week_yyyyww` | integer | ISO week in YYYYWW format |
| `determined_week` | logical | TRUE if week was determined |

### Algorithm Overview

1. **Preprocessing**: Convert input to data.table, handle special codes (99, 9999)
2. **Saturday calculation**: Compute first valid interview Saturday for each month
3. **Birthday constraints**: Narrow interview date range based on respondent birthdates
4. **Period position conversion**: Convert date bounds to month/fortnight/week positions
5. **Cross-quarter aggregation** (months only): Aggregate constraints at UPA-V1014 level across ALL quarters
6. **Within-quarter aggregation** (fortnight/week): Aggregate at household level within each quarter
7. **Exception detection**: Identify quarters requiring relaxed rules
8. **Final determination**: If min position == max position, period is determined

---

## `pnadc_experimental_periods()`

Experimental function providing probabilistic period assignment for narrow ranges.

### Function Signature

```{r}
pnadc_experimental_periods(
  crosswalk,
  data = NULL,
  strategy = c("none", "probabilistic", "upa_aggregation", "both"),
  upa_homogeneity_threshold = 0.80,
  verbose = TRUE
)
```

### Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `crosswalk` | data.table | (required) | Crosswalk from `pnadc_identify_periods()` |
| `data` | data.table | NULL | Original PNADC data (required for probabilistic) |
| `strategy` | character | "none" | Strategy to apply |
| `upa_homogeneity_threshold` | numeric | 0.80 | Threshold for UPA aggregation |
| `verbose` | logical | TRUE | Display progress information |

### Strategies

1. **probabilistic**: For undetermined cases where the date range spans exactly 2 periods,
   calculates the probability-weighted best guess based on date midpoint position.

2. **upa_aggregation**: Aggregates constraints at UPA level. For each UPA where all
   strictly determined households have the same fortnight/week, propagates that
   assignment to undetermined households in the same UPA.

3. **both**: Applies both strategies sequentially (probabilistic first, then UPA aggregation).

### Additional Output Columns

| Column | Type | Description |
|--------|------|-------------|
| `ref_fortnight_likely` | integer | Probabilistic fortnight assignment |
| `ref_fortnight_confidence` | numeric | Confidence score 0.5-1.0 |
| `ref_week_likely` | integer | Probabilistic week assignment |
| `ref_week_confidence` | numeric | Confidence score 0.5-1.0 |
| `ref_fortnight_upa` | integer | UPA-aggregated fortnight |
| `ref_week_upa` | integer | UPA-aggregated week |

---

# Benchmark Results

## Test Environment

| Component | Specification |
|-----------|---------------|
| **R version** | 4.5.0 |
| **Platform** | Windows 11 x64 |
| **data.table version** | 1.16+ |
| **Test date** | 2026-01-18 |

## Period Identification Performance

### `pnadc_identify_periods()`

| Metric | Value |
|--------|-------|
| **Execution time** | 160.2 seconds |
| **Input rows** | 28,395,273 |
| **Output rows** | 9,598,723 |
| **Throughput** | 177,303 rows/sec |
| **Memory (output)** | 918.1 MB |

### `pnadc_experimental_periods()`

| Metric | Value |
|--------|-------|
| **Execution time** | 681.4 seconds |
| **Input rows** | 9,598,723 (crosswalk) |
| **Throughput** | 14,088 rows/sec |
| **Memory (output)** | 1.1 GB |

---

# Determination Rate Analysis

## Overall Rates

| Period | Determined | Total | Rate |
|--------|------------|-------|------|
| **Month** | 9,281,135 | 9,598,723 | **96.69%** |
| **Fortnight** | 733,744 | 9,598,723 | **7.64%** |
| **Week** | 147,692 | 9,598,723 | **1.54%** |

## Rates by Year

| Year | N | Month % | Fortnight % | Week % |
|------|---|---------|-------------|--------|
| 2012 | 695,083 | 96.29 | 8.46 | 1.65 |
| 2013 | 719,697 | 98.72 | 8.52 | 1.39 |
| 2014 | 739,655 | 98.39 | 8.08 | 1.30 |
| 2015 | 745,247 | 98.24 | 8.12 | 1.62 |
| 2016 | 749,631 | 97.22 | 7.69 | 2.08 |
| 2017 | 752,066 | 96.88 | 7.49 | 1.78 |
| 2018 | 750,274 | 97.07 | 7.60 | 1.47 |
| 2019 | 746,873 | 97.63 | 7.79 | 1.26 |
| 2020 | 535,970 | 96.26 | 7.61 | 1.27 |
| 2021 | 544,817 | 93.29 | 6.86 | 1.94 |
| 2022 | 679,389 | 95.03 | 7.05 | 1.73 |
| 2023 | 690,749 | 96.18 | 7.09 | 1.66 |
| 2024 | 708,340 | 97.27 | 7.30 | 1.28 |
| 2025 | 540,932 | 93.07 | 6.91 | 0.99 |

## Rates by Quarter

| Quarter | N | Month % | Fortnight % | Week % |
|---------|---|---------|-------------|--------|
| Q1 | 2,439,072 | 96.58 | 7.46 | 1.49 |
| Q2 | 2,425,552 | 96.77 | 7.88 | 1.65 |
| Q3 | 2,468,025 | 96.38 | 7.78 | 1.56 |
| Q4 | 2,266,074 | 97.06 | 7.44 | 1.45 |

---

# Distribution Analysis

## Month Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Month 1 | 3,144,100 | 33.88% |
| Month 2 | 3,046,495 | 32.82% |
| Month 3 | 3,090,540 | 33.30% |

## Fortnight Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Fortnight 1 | 110,060 | 15.00% |
| Fortnight 2 | 135,157 | 18.42% |
| Fortnight 3 | 94,558 | 12.89% |
| Fortnight 4 | 146,057 | 19.91% |
| Fortnight 5 | 102,265 | 13.94% |
| Fortnight 6 | 145,647 | 19.85% |

## Week Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Week 1 | 30,895 | 20.92% |
| Week 5 | 19,615 | 13.28% |
| Week 9 | 21,841 | 14.79% |
| Week 12 | 25,301 | 17.13% |
| Week 13 | 14,987 | 10.15% |

---

# Experimental Results

## Strategy Comparison

| Strategy | Threshold | Fortnight % | Week % | Time (s) |
|----------|-----------|-------------|--------|----------|
| probabilistic | 0.8 | 13.61% | 1.82% | 221.0 |
| upa_aggregation | 0.8 | 57.69% | 14.36% | 15.2 |
| both | 0.8 | **60.33%** | **14.60%** | 235.1 |

## UPA Homogeneity Analysis

| Period | Homogeneity Rate | Applied |
|--------|------------------|---------|
| Fortnight | **100.0%** | Yes |
| Week | **100.0%** | Yes |

**Key finding:** Whenever a fortnight or week IS strictly determined for any household
in a UPA, ALL strictly determined households in that UPA have the SAME fortnight/week.

---

# Recommendations

## When to Use Each Strategy

| Scenario | Recommended Strategy | Notes |
|----------|---------------------|-------|
| **Conservative analysis** | `pnadc_identify_periods()` | Strict determination only |
| **Moderate coverage** | `strategy = "probabilistic"` | Adds confidence scores |
| **Maximum coverage** | `strategy = "upa_aggregation"` | Best coverage |
| **Comprehensive** | `strategy = "both"` | Combines all strategies |

---

# Session Info

```{r, eval=TRUE, echo=FALSE}
sessionInfo()
```

---

*Report generated: `r Sys.time()`*

*Package version: PNADCperiods 2.0.0*
