<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Download and Prepare PNADC Data</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Download and Prepare PNADC Data</h1>



<!--
MAINTAINER NOTE:
This vignette uses eval=FALSE for all code chunks.
Pre-computed outputs are shown as text blocks.
-->
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This vignette provides a complete, step-by-step workflow for
downloading Brazil’s quarterly PNADC (Pesquisa Nacional por Amostra de
Domicilios Continua) survey data and preparing it for mensalization. By
the end, you will have monthly reference months identified for each
survey observation and optionally computed monthly survey weights.</p>
<p>The workflow covers three main tasks:</p>
<ol style="list-style-type: decimal">
<li><strong>Downloading</strong> quarterly PNADC microdata from IBGE
using the <code>PNADcIBGE</code> package</li>
<li><strong>Stacking</strong> multiple quarters into a single dataset
(critical for high determination rates)</li>
<li><strong>Applying mensalization</strong> using the
<code>mensalizePNADC</code> package</li>
</ol>
<p>If you already have PNADC data and want to learn the package API
first, see <a href="getting-started.html">Get Started</a>. For algorithm
details, see <a href="how-it-works.html">How mensalizePNADC
Works</a>.</p>
</div>
<div id="prerequisites" class="section level2">
<h2>Prerequisites</h2>
<div id="required-packages" class="section level3">
<h3>Required Packages</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Install packages if needed</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;PNADcIBGE&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;fst&quot;</span>))</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># Install mensalizePNADC from GitHub</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># install.packages(&quot;remotes&quot;)</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># remotes::install_github(&quot;antrologos/mensalizePNADC&quot;)</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(PNADcIBGE)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">library</span>(fst)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">library</span>(PNADCperiods)</span></code></pre></div>
</div>
<div id="system-requirements" class="section level3">
<h3>System Requirements</h3>
<ul>
<li><strong>Disk space</strong>: ~5 GB for 2020-2024 data, ~15 GB for
full history (2012-present)</li>
<li><strong>RAM</strong>: At least 8 GB recommended; 16 GB for
comfortable processing</li>
<li><strong>Time</strong>: 2-3 hours for downloading (depends on
internet speed), ~5 minutes for processing</li>
<li><strong>Internet</strong>: Required for downloading data and for
SIDRA API access (weight calibration)</li>
</ul>
</div>
</div>
<div id="understanding-pnadc-data" class="section level2">
<h2>Understanding PNADC Data</h2>
<p>PNADC is Brazil’s primary household survey for labor market
statistics, conducted by IBGE. The survey uses a rotating panel design
where each household is interviewed five times over 15 months. Each
quarterly release contains approximately 500,000 observations.</p>
<p><strong>Why stack multiple quarters?</strong> The mensalization
algorithm identifies reference months by tracking households across
their panel interviews. With a single quarter, the determination rate is
only ~73%. By stacking multiple quarters, the algorithm can leverage the
rotating panel structure to achieve a <strong>97% determination
rate</strong>.</p>
<table>
<thead>
<tr class="header">
<th>Quarters Stacked</th>
<th>Determination Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1 (single quarter)</td>
<td>73%</td>
</tr>
<tr class="even">
<td>4 (1 year)</td>
<td>94%</td>
</tr>
<tr class="odd">
<td>8 (2 years)</td>
<td>96%</td>
</tr>
<tr class="even">
<td>20+ (5+ years)</td>
<td><strong>97%</strong></td>
</tr>
</tbody>
</table>
<p>For most applications, we recommend stacking at least 2 years (8
quarters) of data. For a detailed explanation of how determination rates
improve with stacking, including a figure computed from real data, see
the <a href="how-it-works.html#why-stacked-data-matters">How
PNADCperiods Works</a> vignette.</p>
</div>
<div id="step-1-set-up-your-environment" class="section level2">
<h2>Step 1: Set Up Your Environment</h2>
<p>First, create a directory to store the downloaded data:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Set your data directory (adjust path as needed)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">&quot;path/to/your/pnadc_data/&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># Create directory if it doesn&#39;t exist</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">dir.create</span>(data_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="step-2-define-which-quarters-to-download" class="section level2">
<h2>Step 2: Define Which Quarters to Download</h2>
<p>Create a grid of year-quarter combinations to download. This example
uses 2020-2024, which provides a good balance between data size and
determination rate:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Define quarters to download (2020-2024 example)</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>editions <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2020</span><span class="sc">:</span><span class="dv">2024</span>,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">quarter =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="co"># Remove quarters not yet available</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(year <span class="sc">==</span> <span class="dv">2024</span> <span class="sc">&amp;</span> quarter <span class="sc">&gt;</span> <span class="dv">3</span>))</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co"># View the grid</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>editions</span></code></pre></div>
<p>This creates a grid of 19 quarters. Adjust the filter for the most
recent available quarter.</p>
</div>
<div id="step-3-download-the-data" class="section level2">
<h2>Step 3: Download the Data</h2>
<p>The download loop fetches each quarter from IBGE and saves it in FST
format for fast loading later:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Download and save each quarter</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(editions)) {</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  year_i <span class="ot">&lt;-</span> editions<span class="sc">$</span>year[i]</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  quarter_i <span class="ot">&lt;-</span> editions<span class="sc">$</span>quarter[i]</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;pnadc_&quot;</span>, year_i, <span class="st">&quot;-&quot;</span>, quarter_i, <span class="st">&quot;q.fst&quot;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Downloading:&quot;</span>, year_i, <span class="st">&quot;Q&quot;</span>, quarter_i, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="co"># Download from IBGE</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  pnadc_quarter <span class="ot">&lt;-</span> <span class="fu">get_pnadc</span>(</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="at">year =</span> year_i,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="at">quarter =</span> quarter_i,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="at">labels =</span> <span class="cn">FALSE</span>,    <span class="co"># IMPORTANT: Use numeric codes, not labels</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="at">deflator =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="at">design =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    <span class="at">savedir =</span> data_dir</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  )</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  <span class="co"># Save as FST format (fast serialization)</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>  <span class="fu">write_fst</span>(pnadc_quarter, <span class="fu">file.path</span>(data_dir, filename))</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="co"># Clean up temporary files created by PNADcIBGE</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  temp_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir,</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>                           <span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(zip|sas|txt)$&quot;</span>,</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>                           <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  <span class="fu">file.remove</span>(temp_files)</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  <span class="co"># Free memory</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="fu">rm</span>(pnadc_quarter)</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p><strong>Important</strong>: Always use <code>labels = FALSE</code>
when downloading. The mensalization algorithm requires numeric codes for
the birthday variables (V2008, V20081, V20082). Using labeled factors
will cause errors.</p>
</blockquote>
<p>This loop will take 2-3 hours depending on your internet connection.
Each quarter is approximately 300-400 MB when saved as FST.</p>
</div>
<div id="step-4-stack-the-quarterly-files" class="section level2">
<h2>Step 4: Stack the Quarterly Files</h2>
<p>Now stack all the quarterly files into a single dataset. To save
memory, we only load the columns needed for mensalization:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Columns needed for mensalization</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>cols_needed <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="co"># Time and identifiers</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="st">&quot;Ano&quot;</span>, <span class="st">&quot;Trimestre&quot;</span>, <span class="st">&quot;UPA&quot;</span>, <span class="st">&quot;V1008&quot;</span>, <span class="st">&quot;V1014&quot;</span>, <span class="st">&quot;V2003&quot;</span>,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="co"># Birthday variables (for reference month algorithm)</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="st">&quot;V2008&quot;</span>, <span class="st">&quot;V20081&quot;</span>, <span class="st">&quot;V20082&quot;</span>, <span class="st">&quot;V2009&quot;</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="co"># Weight and stratification (for weight calibration)</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  <span class="st">&quot;V1028&quot;</span>, <span class="st">&quot;UF&quot;</span>, <span class="st">&quot;posest&quot;</span>, <span class="st">&quot;posest_sxi&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co"># Stack all quarters</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>pnadc_stacked <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(editions)) {</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  year_i <span class="ot">&lt;-</span> editions<span class="sc">$</span>year[i]</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  quarter_i <span class="ot">&lt;-</span> editions<span class="sc">$</span>quarter[i]</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;pnadc_&quot;</span>, year_i, <span class="st">&quot;-&quot;</span>, quarter_i, <span class="st">&quot;q.fst&quot;</span>)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading:&quot;</span>, filename, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  <span class="co"># Read only the columns we need (saves memory)</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  quarter_data <span class="ot">&lt;-</span> <span class="fu">read_fst</span>(</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    <span class="fu">file.path</span>(data_dir, filename),</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    <span class="at">columns =</span> cols_needed</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  )</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  pnadc_stacked <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pnadc_stacked, quarter_data)</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="fu">rm</span>(quarter_data)</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>}</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Total observations:&quot;</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(pnadc_stacked), <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<p>Output (from real PNADC 2020-2024 data):</p>
<pre><code>Loading: pnadc_2020-1q.fst
Loading: pnadc_2020-2q.fst
...
Loading: pnadc_2024-4q.fst
Total observations: 8,868,247</code></pre>
</div>
<div id="step-5-apply-mensalization" class="section level2">
<h2>Step 5: Apply Mensalization</h2>
<p>Now apply the period identification algorithm and optionally compute
calibrated weights:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Step 1: Build crosswalk (identify reference periods)</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>crosswalk <span class="ot">&lt;-</span> <span class="fu">pnadc_identify_periods</span>(pnadc_stacked, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co"># Check the determination rate</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Determination rate:&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">&quot;%.1f%%&quot;</span>, <span class="fu">attr</span>(crosswalk, <span class="st">&quot;determination_rates&quot;</span>)<span class="sc">$</span>month <span class="sc">*</span> <span class="dv">100</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co"># Step 2: Apply crosswalk and calibrate weights</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">pnadc_apply_periods</span>(</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="at">data =</span> pnadc_stacked,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="at">crosswalk =</span> crosswalk,</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="at">weight_var =</span> <span class="st">&quot;V1028&quot;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="at">anchor =</span> <span class="st">&quot;quarter&quot;</span>,</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="at">calibrate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>)</span></code></pre></div>
<p>Output (from real PNADC 2020-2024 data):</p>
<pre><code>Building reference period crosswalk...
  Preprocessing data (shared computation)...
  Converting date bounds to period positions...
  Aggregating constraints and determining periods...
  Applying exception rules...
  Assigning reference periods...
  Building crosswalk...

Crosswalk complete:
  - 3,159,265 unique household-quarter observations
  - Month determination: 94.2%
  - Fortnight determination: 2.8%
  - Week determination: 0.9%</code></pre>
<p>The determination rate tells you what percentage of observations have
their reference period identified. With 20 quarters stacked (2020-2024),
we achieve 94.2% for months.</p>
</div>
<div id="step-6-explore-the-results" class="section level2">
<h2>Step 6: Explore the Results</h2>
<p>The result is a data.table with several new columns:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># View the result structure</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">glimpse</span>(result)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># Summary of reference month distribution</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>result <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="fu">count</span>(ref_month_in_quarter) <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span></code></pre></div>
<p>Output (from real PNADC 2020-2024 data):</p>
<pre><code>   ref_month_in_quarter       N   pct
1:                    1 1020409  32.3
2:                    2  965613  30.6
3:                    3  990865  31.4
4:                   NA  182378   5.8</code></pre>
<p>The distribution is approximately equal across months 1, 2, and 3
(each around 31-32%), with 5.8% having <code>NA</code> for indeterminate
cases (this is higher than the ~3% seen with full 2012-2025 data because
boundary quarters have lower determination rates).</p>
<p>The output columns include:</p>
<table>
<colgroup>
<col width="38%" />
<col width="61%" />
</colgroup>
<thead>
<tr class="header">
<th>Column</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ref_month</code></td>
<td>Reference month as Date (first day of month)</td>
</tr>
<tr class="even">
<td><code>ref_month_in_quarter</code></td>
<td>Position within quarter (1, 2, or 3)</td>
</tr>
<tr class="odd">
<td><code>ref_month_yyyymm</code></td>
<td>Reference month as YYYYMM integer</td>
</tr>
<tr class="even">
<td><code>weight_monthly</code></td>
<td>Monthly survey weight (if <code>compute_weights = TRUE</code>)</td>
</tr>
</tbody>
</table>
<p>Observations with <code>ref_month_in_quarter = NA</code> have
indeterminate reference months and should be excluded from monthly
analyses.</p>
</div>
<div id="step-7-save-and-use-the-results" class="section level2">
<h2>Step 7: Save and Use the Results</h2>
<p>Save the mensalized data for future use:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Save the mensalized crosswalk</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">write_fst</span>(result, <span class="fu">file.path</span>(data_dir, <span class="st">&quot;pnadc_mensalized.fst&quot;</span>))</span></code></pre></div>
<p>To use the results in analysis, join the mensalization crosswalk with
your full PNADC data:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Load a quarterly file with all variables</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>full_data <span class="ot">&lt;-</span> <span class="fu">read_fst</span>(<span class="fu">file.path</span>(data_dir, <span class="st">&quot;pnadc_2023-1q.fst&quot;</span>))</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># Join with mensalization results</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> full_data <span class="sc">|&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    result <span class="sc">|&gt;</span> <span class="fu">select</span>(Ano, Trimestre, UPA, V1008, V1014, V2003,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>                     ref_month, ref_month_in_quarter, weight_monthly),</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;Ano&quot;</span>, <span class="st">&quot;Trimestre&quot;</span>, <span class="st">&quot;UPA&quot;</span>, <span class="st">&quot;V1008&quot;</span>, <span class="st">&quot;V1014&quot;</span>, <span class="st">&quot;V2003&quot;</span>)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  )</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co"># Now you can aggregate by month using weight_monthly</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>monthly_unemployment <span class="ot">&lt;-</span> analysis_data <span class="sc">|&gt;</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ref_month_in_quarter)) <span class="sc">|&gt;</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  <span class="fu">group_by</span>(ref_month) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>    <span class="at">unemployment_rate =</span> <span class="fu">sum</span>((VD4002 <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">*</span> weight_monthly, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>                        <span class="fu">sum</span>((VD4001 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> weight_monthly, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="memory-and-performance-tips" class="section level2">
<h2>Memory and Performance Tips</h2>
<p>Working with PNADC microdata can be memory-intensive. Here are some
tips:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Selective column loading</strong>: Only load the columns
you need with <code>read_fst(..., columns = ...)</code>. This
dramatically reduces memory usage.</p></li>
<li><p><strong>Process in batches</strong>: For very large analyses,
process one year at a time and combine results.</p></li>
<li><p><strong>Use FST format</strong>: FST is much faster than CSV or
RDS for large datasets. A typical quarter loads in seconds rather than
minutes.</p></li>
<li><p><strong>Clean up regularly</strong>: Use <code>rm()</code> and
<code>gc()</code> to free memory after processing each quarter.</p></li>
</ol>
<div id="file-size-reference" class="section level3">
<h3>File Size Reference</h3>
<table>
<thead>
<tr class="header">
<th>Period</th>
<th>Quarters</th>
<th>Observations</th>
<th>FST Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2020-2024</td>
<td>19</td>
<td>~10.8M</td>
<td>~5 GB</td>
</tr>
<tr class="even">
<td>2012-2024</td>
<td>51</td>
<td>~28.4M</td>
<td>~15 GB</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="extending-to-full-history" class="section level2">
<h2>Extending to Full History</h2>
<p>For the best determination rate and longitudinal analysis, download
all available quarters:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Download all available data (2012-present)</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>editions_full <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2012</span><span class="sc">:</span><span class="dv">2025</span>,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="at">quarter =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(year <span class="sc">==</span> <span class="dv">2025</span> <span class="sc">&amp;</span> quarter <span class="sc">&gt;</span> <span class="dv">3</span>))  <span class="co"># Adjust for latest available</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co"># Use the same download and stacking loops as above</span></span></code></pre></div>
<p>The full history provides approximately 28 million observations and
achieves the highest possible determination rate.</p>
</div>
<div id="troubleshooting" class="section level2">
<h2>Troubleshooting</h2>
<div id="common-issues" class="section level3">
<h3>Common Issues</h3>
<ol style="list-style-type: decimal">
<li><p><strong>“Column not found” errors</strong>: Ensure you used
<code>labels = FALSE</code> when downloading. The algorithm requires
numeric codes.</p></li>
<li><p><strong>Download failures</strong>: IBGE servers can be slow or
unavailable. The <code>PNADcIBGE</code> package will retry
automatically, but you may need to restart interrupted
downloads.</p></li>
<li><p><strong>Memory errors</strong>: Try processing fewer quarters at
a time, or use a machine with more RAM.</p></li>
<li><p><strong>SIDRA API errors</strong>: The weight calibration
requires internet access to the SIDRA API. If it fails, try again later
or use <code>compute_weights = FALSE</code> for just reference month
identification.</p></li>
</ol>
</div>
</div>
<div id="next-steps" class="section level2">
<h2>Next Steps</h2>
<p>Now that you have mensalized PNADC data, you can:</p>
<ul>
<li>Follow the usage patterns in <a href="getting-started.html">Get
Started</a> with your real data</li>
<li>See analysis examples in <a href="applied-examples.html">Applied
Examples</a></li>
<li>Learn about the algorithm in <a href="how-it-works.html">How
mensalizePNADC Works</a></li>
<li>Visit the <a href="https://antrologos.github.io/mensalizePNADC/">package website</a>
for more resources</li>
</ul>
<blockquote>
<p><strong>Working with annual PNADC data?</strong> Annual data
(visit-specific microdata with comprehensive income variables) requires
a different workflow. See <a href="annual-poverty-analysis.html">Monthly
Poverty Analysis with Annual PNADC Data</a> for details on using
<code>pnadc_apply_periods()</code> with
<code>anchor = &quot;year&quot;</code>.</p>
</blockquote>
<p>For questions or issues, please open an issue on <a href="https://github.com/antrologos/mensalizePNADC/issues">GitHub</a>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
