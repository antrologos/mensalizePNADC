% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calibrate-weights.R
\name{calibrate_monthly_weights}
\alias{calibrate_monthly_weights}
\title{Calibrate Monthly Weights}
\usage{
calibrate_monthly_weights(
  data,
  monthly_totals,
  n_cells = 4L,
  keep_all = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata including reference
month information (output from \code{\link{identify_reference_month}}).
Required columns include:
\itemize{
\item Reference month columns: \code{ref_month_yyyymm}, \code{ref_month_in_quarter}
\item Survey design: \code{V1028}, \code{UF}, \code{posest}, \code{posest_sxi}
\item Demographics: \code{V2009} (age)
\item Time: \code{Ano}, \code{Trimestre}
}}

\item{monthly_totals}{A data.frame with monthly population totals. Required columns:
\itemize{
\item \code{ref_month_yyyymm} or \code{anomesexato}: YYYYMM integer
\item \code{m_populacao}: Monthly population in thousands
}}

\item{n_cells}{Integer. Number of hierarchical cell levels to use (1-4).
Default is 4 (full hierarchy). Lower values are faster but less precise.}

\item{keep_all}{Logical. If TRUE (default), return all rows including those
with indeterminate reference months (with \code{weight_calibrated = NA}).
If FALSE, only return observations with determined reference months.}

\item{verbose}{Logical. Print progress messages? Default TRUE.}
}
\value{
A data.table with the input data plus:
\itemize{
\item \code{weight_calibrated}: Calibrated monthly weight
\item \code{celula1} through \code{celula4}: Cell identifiers (if computed)
}
}
\description{
The original PNADC survey weights (\code{V1028}) are designed for quarterly
estimates. This function creates monthly weights by:
\enumerate{
\item Grouping observations by nested demographic/geographic cells
\item Iteratively adjusting weights so monthly totals match quarterly totals
within each cell
\item Calibrating final weights against external monthly population totals
}
}
\details{
Redistributes quarterly survey weights to monthly weights using hierarchical
calibration across demographic and geographic cells.

The hierarchical calibration cells are:
\describe{
\item{celula1}{Age groups: 0-13, 14-29, 30-59, 60+}
\item{celula2}{Post-stratum group + age group}
\item{celula3}{State (UF) + celula2}
\item{celula4}{Post-stratum (posest) + celula2}
}

At each level, weights are adjusted so that:
\code{sum(weight_new) by (cell, month) / sum(weight_old) by (cell, month)}
equals
\code{sum(V1028) by (cell, quarter) / sum(weight_old) by (cell, month)}

This preserves the quarterly totals while redistributing to months.
}
\examples{
\dontrun{
# First identify reference months
crosswalk <- identify_reference_month(pnadc_data)
merged <- merge(pnadc_data, crosswalk, by = join_keys)

# Then calibrate weights
result <- calibrate_monthly_weights(merged, monthly_pop)
}

}
\seealso{
\code{\link{identify_reference_month}}, \code{\link{calibrate_to_sidra}}
}
