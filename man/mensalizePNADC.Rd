% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mensalizePNADC.R
\name{mensalizePNADC}
\alias{mensalizePNADC}
\title{Mensalize PNADC Quarterly Survey Data}
\usage{
mensalizePNADC(
  data,
  compute_weights = FALSE,
  keep_all = TRUE,
  output = c("crosswalk", "microdata", "aggregates"),
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.frame or data.table with stacked quarterly PNADC microdata.

For reference month identification only (\code{compute_weights = FALSE}),
minimum required columns are:
\itemize{
\item \code{Ano}, \code{Trimestre}: Year and quarter
\item \code{UPA}, \code{V1014}: Primary sampling unit and panel
\item \code{V2008}, \code{V20081}, \code{V20082}: Birth day, month, year
\item \code{V2009}: Age
}

For monthly weight computation (\code{compute_weights = TRUE}), additional
columns are required. See Details.}

\item{compute_weights}{Logical. If TRUE, compute monthly adjusted survey weights in
addition to identifying reference months. Default is FALSE. Requires the
\code{sidrar} package to fetch population data from IBGE SIDRA API. It makes the monthly
weights sum up to the population results at https://sidra.ibge.gov.br/tabela/6022.}

\item{keep_all}{Logical. If TRUE (default), return all rows from input data,
with \code{weight_monthly = NA} for observations where reference month
could not be determined. If FALSE, only return observations with
determined reference months (smaller output). Only applies when
\code{compute_weights = TRUE}.}

\item{output}{Character. What to return:
\itemize{
\item \code{"crosswalk"} (default): Minimal crosswalk for joining
\item \code{"microdata"}: Full microdata with all computed columns
\item \code{"aggregates"}: Monthly aggregated indicators
}}

\item{verbose}{Logical. Print progress messages? Default TRUE.}
}
\value{
Depends on \code{output} parameter:

If \code{output = "crosswalk"} (default):
A data.table with join keys and new time variables:
\itemize{
\item Join keys: \code{Ano}, \code{Trimestre}, \code{UPA}, \code{V1008}, \code{V1014}, \code{V2003}
\item \code{ref_month}: Reference month as Date
\item \code{ref_month_in_quarter}: Position in quarter (1, 2, 3) or NA
\item \code{ref_month_yyyymm}: Integer YYYYMM format
\item \code{weight_monthly}: Monthly weight (if \code{compute_weights = TRUE})
}

If \code{output = "microdata"}:
Full input data with all computed columns added.

If \code{output = "aggregates"}:
Monthly aggregated indicators.
}
\description{
This function processes stacked quarterly PNADC microdata to:
\enumerate{
\item Identify which month within each quarter each observation refers to
\item Optionally compute monthly adjusted survey weights (if \code{compute_weights = TRUE})
}

The output is a crosswalk table that can be joined with original (stacked or unstacked)
PNADC data files to add monthly time information.
}
\details{
Main function to convert quarterly PNADC survey data to monthly time series.
Returns a crosswalk data.frame for joining with original data, adding
reference month information and optionally monthly survey weights.
\subsection{Reference Month Identification}{

The algorithm determines which month each survey response refers to based on:
\itemize{
\item IBGE's "Parada Tecnica" rules for reference week timing
\item Respondent birthdates (constrains possible interview dates)
\item UPA-panel grouping (everyone interviewed together)
}
}

\subsection{Cross-Quarter Aggregation (Important!)}{

\strong{For optimal determination rates (~97\%), input data should be stacked across
multiple quarter datasets} (ideally 4+ years). The algorithm leverages PNADC's rotating
panel design where the locations defined by the same values in variables
UPA-V1014 are always interviewed in the same relative month within a given quarter
across all quarterly visits.

\itemize{
\item \strong{Per-quarter processing}: ~65-75\% determination rate
\item \strong{Multi-quarter stacked}: ~97\% determination rate
}

The cross-quarter aggregation dramatically improves accuracy by combining
birthday constraints from multiple interview rounds.
}

\subsection{Monthly Weight Computation}{

When \code{compute_weights = TRUE}, the function:
\enumerate{
\item Fetches monthly population from IBGE SIDRA API (table 6022)
\item Redistributes quarterly weights to months using hierarchical rake weighting
\item Smooths monthly aggregates to remove quarterly artifacts
}

The resulting \code{weight_monthly} is the adjusted weight for general-purpose
monthly analysis.

Additional required columns for weight computation:
\itemize{
\item Survey design: \code{V1028}, \code{V1008}, \code{V2003}, \code{UF}, \code{posest}, \code{posest_sxi}
}
}
}
\section{Dependencies}{

When \code{compute_weights = TRUE}, the \code{sidrar} package is required
to fetch population data. Install with: \code{install.packages("sidrar")}
}

\examples{
\dontrun{
# Basic usage: identify reference months only
library(mensalizePNADC)

# Load stacked quarterly data (minimum columns)
pnadc <- data.table::fread("pnadc_stacked.csv",
  select = c("Ano", "Trimestre", "UPA", "V1008", "V1014", "V2003",
             "V2008", "V20081", "V20082", "V2009"))

# Get crosswalk
crosswalk <- mensalizePNADC(pnadc)

# Join with original quarterly file
original <- haven::read_dta("PNADC_2023T1.dta")
monthly <- dplyr::left_join(original, crosswalk,
  by = c("Ano", "Trimestre", "UPA", "V1008", "V1014", "V2003"))


# With monthly weights for general analysis
# (requires sidrar package and internet connection)
pnadc_full <- haven::read_dta("PNADCtrimestralempilhada.dta")

result <- mensalizePNADC(pnadc_full, compute_weights = TRUE)

# Use weight_monthly for any monthly aggregate
result[, .(pop = sum(weight_monthly)), by = ref_month_yyyymm]
}

}
\seealso{
\code{\link{identify_reference_month}} for just reference month identification
}
