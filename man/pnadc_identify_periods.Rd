% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pnadc-identify-periods.R
\name{pnadc_identify_periods}
\alias{pnadc_identify_periods}
\title{Identify Reference Periods in PNADC Data}
\usage{
pnadc_identify_periods(data, verbose = TRUE, store_date_bounds = FALSE)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata. Required columns:
\itemize{
\item \code{Ano}: Survey year
\item \code{Trimestre}: Quarter (1-4)
\item \code{UPA}: Primary Sampling Unit
\item \code{V1008}: Household sequence within UPA
\item \code{V1014}: Panel identifier
\item \code{V2008}: Birth day (1-31)
\item \code{V20081}: Birth month (1-12)
\item \code{V20082}: Birth year
\item \code{V2009}: Age
}
Optional but recommended:
\itemize{
\item \code{V2003}: Person sequence within household
}}

\item{verbose}{Logical. If TRUE (default), display progress information.}

\item{store_date_bounds}{Logical. If TRUE, stores date bounds and exception
flags in the crosswalk for optimization when calling
\code{pnadc_experimental_periods()}. This enables 10-20x speedup for the
probabilistic strategy by avoiding redundant computation. Default FALSE.}
}
\value{
A data.table crosswalk with columns:
\describe{
\item{Ano, Trimestre, UPA, V1008, V1014}{Join keys (year, quarter, UPA, household, panel)}
\item{ref_month_start}{Sunday of first IBGE reference week of the month}
\item{ref_month_end}{Saturday of last IBGE reference week of the month}
\item{ref_month_in_quarter}{Position in quarter (1, 2, 3) or NA}
\item{ref_month_yyyymm}{Integer YYYYMM format (e.g., 202301)}
\item{ref_month_weeks}{Number of IBGE reference weeks in month (4 or 5)}
\item{determined_month}{Logical: TRUE if month was determined}
\item{ref_fortnight_start}{Sunday of first IBGE week of the fortnight}
\item{ref_fortnight_end}{Saturday of last IBGE week of the fortnight}
\item{ref_fortnight_in_quarter}{Position in quarter (1-6) or NA}
\item{ref_fortnight_yyyyff}{Integer YYYYFF format (1-24 per year)}
\item{determined_fortnight}{Logical: TRUE if fortnight was determined}
\item{ref_week_start}{Sunday of the IBGE reference week}
\item{ref_week_end}{Saturday of the IBGE reference week}
\item{ref_week_in_quarter}{Position in quarter (1-14) or NA}
\item{ref_week_yyyyww}{Integer IBGE YYYYWW format}
\item{determined_week}{Logical: TRUE if week was determined}
}
}
\description{
PNADC is a quarterly survey, but each interview actually refers to a specific
temporal period within the quarter. This function identifies which month,
fortnight (quinzena), and week each observation belongs to, enabling
sub-quarterly time series analysis.

The algorithm uses a \strong{nested identification approach}:
\itemize{
\item \strong{Phase 1}: Identify MONTHS for all observations using:
\itemize{
\item IBGE's reference week timing rules (first Saturday with sufficient days)
\item Respondent birthdates to constrain possible interview dates
\item UPA-panel level aggregation across ALL quarters (panel design)
\item Dynamic exception detection (identifies quarters needing relaxed rules)
}
\item \strong{Phase 2}: Identify FORTNIGHTS only for month-determined observations:
\itemize{
\item Search space constrained to 2 fortnights within determined month
\item Household-level aggregation within each quarter
}
\item \strong{Phase 3}: Identify WEEKS only for fortnight-determined observations:
\itemize{
\item Search space constrained to ~2 weeks within determined fortnight
\item Household-level aggregation within each quarter
}
}
}
\details{
Builds a universal crosswalk containing reference periods (month, fortnight,
and week) for PNADC survey data based on IBGE's interview timing rules.
\subsection{Temporal Granularity}{

The crosswalk contains three levels of temporal granularity:
\itemize{
\item \strong{Month}: 3 per quarter, ~97\% determination rate (aggregates across quarters)
\item \strong{Fortnight (quinzena)}: 6 per quarter, ~2-8\% determination rate (within-quarter only)
\item \strong{Week}: 13-14 per quarter, ~1-2\% determination rate (within-quarter only)
}
}

\subsection{Cross-Quarter Aggregation (Important!)}{

\strong{For optimal month determination rates, input data should be stacked across
multiple quarters} (ideally 4+ years). The algorithm leverages PNADC's
rotating panel design where the same UPA-V1014 is interviewed in the same
relative position across quarterly visits.
}

\subsection{Fortnight Definition}{

Fortnights are numbered 1-24 per year (2 per month):
\itemize{
\item Fortnight 01: Jan 1-15
\item Fortnight 02: Jan 16-31
\item Fortnight 03: Feb 1-15
\item ... and so on
}
}
}
\note{
\subsection{Nested Identification Hierarchy}{

The algorithm enforces strict nesting by construction:
\itemize{
\item Fortnights can ONLY be identified for observations with determined months
\item Weeks can ONLY be identified for observations with determined fortnights
}

This guarantees: \code{determined_week => determined_fortnight => determined_month}
}

\subsection{Aggregation Levels}{

The crosswalk aggregates at different levels:
\itemize{
\item \strong{Months}: UPA-V1014 level across ALL quarters
(PNADC panel design ensures same month position)
\item \strong{Fortnights}: Household level within quarter only
\item \strong{Weeks}: Household level within quarter only
}
}
}
\examples{
\dontrun{
# Build crosswalk from stacked quarterly data
crosswalk <- pnadc_identify_periods(pnadc_stacked)

# Check determination rates
crosswalk[, .(
  month_rate = mean(determined_month),
  fortnight_rate = mean(determined_fortnight),
  week_rate = mean(determined_week)
)]

# Verify nesting (always TRUE by construction)
crosswalk[determined_fortnight, all(determined_month)]
crosswalk[determined_week, all(determined_fortnight)]

# Apply to a specific dataset
result <- pnadc_apply_periods(pnadc_2023, crosswalk,
                              weight_var = "V1028",
                              anchor = "quarter")
}

}
\seealso{
\code{\link{pnadc_apply_periods}} to apply the crosswalk and
calibrate weights
}
