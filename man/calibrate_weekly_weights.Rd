% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calibrate-weekly-weights.R
\name{calibrate_weekly_weights}
\alias{calibrate_weekly_weights}
\title{Calibrate Weekly Weights}
\usage{
calibrate_weekly_weights(
  data,
  weekly_totals,
  n_cells = 4L,
  keep_all = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata including reference
week information (output from \code{\link{identify_reference_week}}).
Required columns include:
\itemize{
\item Reference week columns: \code{ref_week_iso_yyyyww}, \code{ref_week_in_quarter}
\item Survey design: \code{V1028}, \code{UF}, \code{posest}, \code{posest_sxi}
\item Demographics: \code{V2009} (age)
\item Time: \code{Ano}, \code{Trimestre}
}}

\item{weekly_totals}{A data.frame with weekly population totals. Required columns:
\itemize{
\item \code{ref_week_iso_yyyyww}: YYYYWW integer (ISO year-week)
\item \code{w_populacao}: Weekly population in thousands
}}

\item{n_cells}{Integer. Number of hierarchical cell levels to use (1-4).
Default is 4 (full hierarchy). Lower values are faster but less precise.}

\item{keep_all}{Logical. If TRUE (default), return all rows including those
with indeterminate reference weeks (with \code{weight_weekly = NA}).
If FALSE, only return observations with determined reference weeks.}

\item{verbose}{Logical. Print progress messages? Default TRUE.}
}
\value{
A data.table with the input data plus:
\itemize{
\item \code{weight_weekly}: Calibrated weekly weight
\item \code{celula1} through \code{celula4}: Cell identifiers (if computed)
}
}
\description{
The original PNADC survey weights (\code{V1028}) are designed for quarterly
estimates. This function creates weekly weights by:
\enumerate{
\item Grouping observations by nested demographic/geographic cells
\item Iteratively adjusting weights so weekly totals match quarterly totals
within each cell
\item Calibrating final weights against external weekly population totals
}

\strong{Important:} Weekly population targets are interpolated from monthly SIDRA
data (Table 6022) because IBGE does not publish official weekly estimates.
The resulting weights are approximations.
}
\details{
Redistributes quarterly survey weights to weekly weights using hierarchical
calibration across demographic and geographic cells.

The hierarchical calibration cells are:
\describe{
\item{celula1}{Age groups: 0-13, 14-29, 30-59, 60+}
\item{celula2}{Post-stratum group + age group}
\item{celula3}{State (UF) + celula2}
\item{celula4}{Post-stratum (posest) + celula2}
}

At each level, weights are adjusted so that:
\code{sum(weight_new) by (cell, week) / sum(weight_old) by (cell, week)}
equals
\code{sum(V1028) by (cell, quarter) / sum(weight_old) by (cell, week)}

This preserves the quarterly totals while redistributing to weeks.
}
\seealso{
\code{\link{identify_reference_week}}, \code{\link{semanalizePNADC}}
}
