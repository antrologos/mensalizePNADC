% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/identify-reference-month.R
\name{identify_reference_month}
\alias{identify_reference_month}
\title{Identify Reference Month in PNADC Data}
\usage{
identify_reference_month(data, verbose = TRUE, .pb = NULL, .pb_offset = 0L)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata. Required columns:
\itemize{
\item \code{Ano}: Survey year
\item \code{Trimestre}: Quarter (1-4)
\item \code{UPA}: Primary Sampling Unit
\item \code{V1014}: Panel identifier
\item \code{V2008}: Birth day (1-31)
\item \code{V20081}: Birth month (1-12)
\item \code{V20082}: Birth year
\item \code{V2009}: Age
}
Optional but recommended for complete crosswalk:
\itemize{
\item \code{V1008}: Household sequence within UPA
\item \code{V2003}: Person sequence within household
}}

\item{verbose}{Logical. If TRUE (default), display progress bar and step information.}

\item{.pb}{Optional progress bar object created by \code{txtProgressBar}. If provided,
the function updates this progress bar instead of creating its own. Used internally
by \code{pnadc_identify_periods()} to show unified progress across all steps.}

\item{.pb_offset}{Integer. Offset to add to progress bar updates when using an external
progress bar. Default is 0.}
}
\value{
A data.table with the original key columns plus:
\itemize{
\item \code{ref_month_start}: Reference month start (Sunday of first IBGE reference week)
\item \code{ref_month_end}: Reference month end (Saturday of last IBGE reference week)
\item \code{ref_month_in_quarter}: Position in quarter (1, 2, 3) or NA if indeterminate
\item \code{ref_month_yyyymm}: Integer YYYYMM format (e.g., 202301)
\item \code{ref_month_weeks}: Number of IBGE weeks in this month (4 or 5)
}
}
\description{
PNADC is a quarterly survey, but each interview actually refers to a specific
month within the quarter. This function identifies which month that observation belongs
to, enabling a shorter term time series analysis.

The algorithm uses:
\itemize{
\item IBGE's reference week timing rules (first Saturday with sufficient days in month)
\item Respondent birthdates to constrain possible interview dates
\item UPA-panel level aggregation (everyone in same sampling unit interviewed together)
\item Dynamic exception detection (identifies quarters needing relaxed rules from the data)
}
}
\details{
Determines which month within each quarter corresponds to each survey
observation based on IBGE's "Parada Tecnica" (technical break) rules.
\subsection{Exception Detection}{

This function detects which quarters need relaxed timing rules
based on the data itself.

The algorithm detects exceptions at the per-month level within each quarter:
\itemize{
\item Checks if standard rules produce impossible results (min > max)
\item Checks if relaxed rules would resolve the issue
\item Applies exception rules to entire quarter when any UPA requires it
}
}

\subsection{Cross-Quarter Aggregation (Important!)}{

\strong{For optimal determination rates (~97\%), input data should be stacked across
multiple quarters} (ideally 4+ years). The algorithm leverages PNADC's rotating
panel design where the same UPA-V1014 is interviewed in the same relative week
across all quarterly visits.

\itemize{
\item \strong{Per-quarter processing}: ~65-75\% determination rate
\item \strong{Multi-quarter stacked}: ~97\% determination rate
}
}

\subsection{Processing Steps}{

The function processes data in the following steps:
\enumerate{
\item Calculate first valid interview Saturday for each month in quarter (standard rule)
\item For each person, calculate possible interview date range based on birthday constraints
\item Convert date ranges to month-in-quarter positions
\item Aggregate to UPA-panel level (all persons must agree)
\item Calculate alternative (exception) date ranges and positions
\item Dynamically detect which quarters/months need exception rules
\item Apply exception rules and recalculate final month positions
}
}
}
\examples{
\dontrun{
# Identify reference months
result <- identify_reference_month(pnadc_data)

# Check determination rate
result[, .(
  total = .N,
  determined = sum(!is.na(ref_month_in_quarter)),
  rate = mean(!is.na(ref_month_in_quarter))
), by = .(Ano, Trimestre)]
}

}
