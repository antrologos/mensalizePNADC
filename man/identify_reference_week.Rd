% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/identify-reference-week.R
\name{identify_reference_week}
\alias{identify_reference_week}
\title{Identify Reference Week in PNADC Data}
\usage{
identify_reference_week(data, verbose = TRUE, .pb = NULL, .pb_offset = 0L)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata. Required columns:
\itemize{
\item \code{Ano}: Survey year
\item \code{Trimestre}: Quarter (1-4)
\item \code{UPA}: Primary Sampling Unit
\item \code{V1008}: Household sequence within UPA
\item \code{V1014}: Panel identifier
\item \code{V2008}: Birth day (1-31)
\item \code{V20081}: Birth month (1-12)
\item \code{V20082}: Birth year
\item \code{V2009}: Age
}
Optional but recommended for complete crosswalk:
\itemize{
\item \code{V2003}: Person sequence within household
}}

\item{verbose}{Logical. If TRUE (default), display progress bar and step information.}

\item{.pb}{Optional progress bar object created by \code{txtProgressBar}. If provided,
the function updates this progress bar instead of creating its own.}

\item{.pb_offset}{Integer. Offset to add to progress bar updates when using an external
progress bar. Default is 0.}
}
\value{
A data.table with the original key columns plus:
\itemize{
\item \code{ref_week}: Reference week as Date (Monday of that week)
\item \code{ref_week_in_quarter}: Position in quarter (1-14) or NA if indeterminate
\item \code{ref_week_iso_yyyyww}: Integer YYYYWW format (e.g., 202301)
}
}
\description{
PNADC is a quarterly survey where each interview occurs during a specific
week within the quarter. This function identifies which ISO 8601 week that
observation belongs to, enabling weekly time series analysis.

The algorithm uses:
\itemize{
\item IBGE's reference week timing rules (first Saturday with sufficient days in month)
\item Respondent birthdates to constrain possible interview dates
\item Household-level aggregation (all persons in same household interviewed on same day)
\item Dynamic exception detection (identifies quarters needing relaxed rules from the data)
}

\strong{Key difference from monthly identification:} This function aggregates at the
household level WITHIN each quarter, not at the UPA-V1014 level across quarters.
This is because households are interviewed in the same month position across
quarterly visits, but NOT in the same week position.
}
\details{
Determines which ISO week each survey observation corresponds to based on
IBGE's interview timing rules and birthday constraints.
\subsection{Household Aggregation}{

All persons in the same household (UPA + V1008) are interviewed on the same day.
The algorithm aggregates birthday constraints across household members to narrow
down the possible interview week:
\itemize{
\item If person A has weeks 2-4 as possibilities
\item And person B has weeks 3-5 as possibilities
\item The household's interview week must be 3-4 (the intersection)
}

Aggregation is done by \code{(Ano, Trimestre, UPA, V1008)} - within each quarter
only, because households are NOT interviewed in the same week across quarterly visits.
}

\subsection{Expected Determination Rate}{

The weekly determination rate (~50-75\%) is lower than monthly (~97\%) because:
\itemize{
\item Cannot aggregate across quarters (no consistent week position in panel design)
\item Finer granularity (13 weeks vs 3 months per quarter)
}
}

\subsection{ISO 8601 Weeks}{

Weeks follow ISO 8601 standard:
\itemize{
\item Week 1 is the week containing January 4th
\item Weeks start on Monday
\item Dec 31 may be in week 1 of the following year
}
}
}
\examples{
\dontrun{
# Identify reference weeks
result <- identify_reference_week(pnadc_data)

# Check determination rate
result[, .(
  total = .N,
  determined = sum(!is.na(ref_week_in_quarter)),
  rate = mean(!is.na(ref_week_in_quarter))
), by = .(Ano, Trimestre)]
}

}
