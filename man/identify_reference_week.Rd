% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/identify-reference-week.R
\name{identify_reference_week}
\alias{identify_reference_week}
\title{Identify Reference Week in PNADC Data}
\usage{
identify_reference_week(data, verbose = TRUE, .pb = NULL, .pb_offset = 0L)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata. Required columns:
\itemize{
\item \code{Ano}: Survey year
\item \code{Trimestre}: Quarter (1-4)
\item \code{UPA}: Primary Sampling Unit
\item \code{V1008}: Household sequence within UPA
\item \code{V1014}: Panel identifier
\item \code{V2008}: Birth day (1-31)
\item \code{V20081}: Birth month (1-12)
\item \code{V20082}: Birth year
\item \code{V2009}: Age
}
Optional but recommended for complete crosswalk:
\itemize{
\item \code{V2003}: Person sequence within household
}}

\item{verbose}{Logical. If TRUE (default), display progress bar and step information.}

\item{.pb}{Optional progress bar object created by \code{txtProgressBar}. If provided,
the function updates this progress bar instead of creating its own.}

\item{.pb_offset}{Integer. Offset to add to progress bar updates when using an external
progress bar. Default is 0.}
}
\value{
A data.table with the original key columns plus:
\itemize{
\item \code{ref_week_start}: Reference week start (Sunday of IBGE week)
\item \code{ref_week_end}: Reference week end (Saturday of IBGE week)
\item \code{ref_week_in_quarter}: Position in quarter (1-12, always 4 weeks
per month × 3 months = 12 weeks per quarter) or NA if indeterminate.
Technical stops are handled via fallback rules (see Technical Stops section).
\item \code{ref_week_yyyyww}: Integer YYYYWW format (IBGE-based)
}
}
\description{
PNADC is a quarterly survey where each interview occurs during a specific
week within the quarter. This function identifies which IBGE reference week
that observation belongs to, enabling weekly time series analysis.

The algorithm uses:
\itemize{
\item IBGE's reference week timing rules (first Saturday with sufficient days in month)
\item IBGE week boundaries (Sunday-Saturday, not ISO Monday-Sunday)
\item Respondent birthdates to constrain possible interview dates
\item Household-level aggregation (all persons in same household interviewed on same day)
\item Dynamic exception detection (identifies quarters needing relaxed rules from the data)
}

\strong{Key difference from monthly identification:} This function aggregates at the
household level WITHIN each quarter, not at the UPA-V1014 level across quarters.
This is because households are interviewed in the same month position across
quarterly visits, but NOT in the same week position.
}
\details{
Determines which IBGE reference week each survey observation corresponds to
based on IBGE's interview timing rules and birthday constraints.
\subsection{Household Aggregation}{

All persons in the same household (UPA + V1008) are interviewed on the same day.
The algorithm aggregates birthday constraints across household members to narrow
down the possible interview week:
\itemize{
\item If person A has weeks 2-4 as possibilities
\item And person B has weeks 3-5 as possibilities
\item The household's interview week must be 3-4 (the intersection)
}

Aggregation is done by \code{(Ano, Trimestre, UPA, V1008)} - within each quarter
only, because households are NOT interviewed in the same week across quarterly visits.
}

\subsection{Expected Determination Rate}{

The weekly determination rate (~1.5\%) is much lower than monthly (~97\%) because:
\itemize{
\item Cannot aggregate across quarters (no consistent week position in panel design)
\item Finer granularity (12 weeks vs 3 months per quarter)
\item Birthday constraints rarely narrow the interview window to a single 7-day period
}
}

\subsection{IBGE Reference Weeks}{

Weeks follow IBGE reference calendar:
\itemize{
\item Weeks start on Sunday and end on Saturday
\item A week belongs to the IBGE month where its Saturday falls
\item The first valid Saturday must have >= 4 days in the month
\item Each IBGE month has exactly 4 reference weeks (28 days)
\item Each IBGE quarter has exactly 12 reference weeks
}
}

\subsection{Technical Stops (Paradas Técnicas)}{

Technical stops are periods (full weeks from Sunday to Saturday) that fall
between valid IBGE reference weeks. They are NOT part of any IBGE month.
When a person's possible date range falls entirely within a technical stop,
the following rules are applied:

\itemize{
\item \strong{Rule 3.1 - Quarter boundary}: If the technical stop is between
quarters, the interview is assigned to the last valid week of the quarter
the observation belongs to (week 12), since interviews must belong to
their source quarter.
\item \strong{Rule 3.2 - Household consensus}: If the technical stop is within
a quarter, the algorithm checks if other household members have a valid
week assignment. If all assigned members agree on a single week, that
week is used.
\item \strong{Rule 3.3 - Fallback}: If no household consensus exists, the
interview is assigned to the first valid week AFTER the technical stop
(that still belongs to the same quarter).
}
}
}
\examples{
\dontrun{
# Identify reference weeks
result <- identify_reference_week(pnadc_data)

# Check determination rate
result[, .(
  total = .N,
  determined = sum(!is.na(ref_week_in_quarter)),
  rate = mean(!is.na(ref_week_in_quarter))
), by = .(Ano, Trimestre)]
}

}
