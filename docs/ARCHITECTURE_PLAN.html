<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>PNADCperiods - Architecture Documentation • PNADCperiods</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="PNADCperiods - Architecture Documentation"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">PNADCperiods</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="articles/applied-examples.html">Applied Examples</a></li>
    <li><a class="dropdown-item" href="articles/annual-poverty-analysis.html">Annual Poverty Analysis</a></li>
    <li><a class="dropdown-item" href="articles/complex-survey-design.html">Complex Survey Design</a></li>
    <li><a class="dropdown-item" href="articles/how-it-works.html">How PNADCperiods Works</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/mensalizePNADC/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>PNADCperiods - Architecture Documentation</h1>
      <small class="dont-index">Source: <a href="https://github.com/antrologos/mensalizePNADC/blob/HEAD/ARCHITECTURE_PLAN.md" class="external-link"><code>ARCHITECTURE_PLAN.md</code></a></small>
    </div>

<div id="pnadcperiods---architecture-documentation" class="section level1">

<p>This document describes the implemented architecture of the PNADCperiods package (v2.0.0).</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><strong>Package name:</strong> <code>PNADCperiods</code> <strong>Purpose:</strong> Identify reference periods (months, fortnights, weeks) in Brazil’s PNADC survey data and optionally calibrate weights for sub-quarterly analysis.</p>
</div>
<div class="section level2">
<h2 id="api-design">API Design<a class="anchor" aria-label="anchor" href="#api-design"></a></h2>
<div class="section level3">
<h3 id="two-main-functions">Two Main Functions<a class="anchor" aria-label="anchor" href="#two-main-functions"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/pnadc_identify_periods.html">pnadc_identify_periods()</a></code></td>
<td>Build crosswalk with month/fortnight/week identification</td>
</tr><tr><td><code><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code></td>
<td>Apply crosswalk to data + optional weight calibration</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="supporting-functions-exported">Supporting Functions (Exported)<a class="anchor" aria-label="anchor" href="#supporting-functions-exported"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/identify_reference_month.html">identify_reference_month()</a></code></td>
<td>Standalone month identification</td>
</tr><tr><td><code><a href="reference/identify_reference_fortnight.html">identify_reference_fortnight()</a></code></td>
<td>Standalone fortnight identification</td>
</tr><tr><td><code><a href="reference/identify_reference_week.html">identify_reference_week()</a></code></td>
<td>Standalone week identification</td>
</tr><tr><td><code><a href="reference/fetch_monthly_population.html">fetch_monthly_population()</a></code></td>
<td>Fetch population from SIDRA API</td>
</tr><tr><td><code><a href="reference/validate_pnadc.html">validate_pnadc()</a></code></td>
<td>Input validation</td>
</tr><tr><td><code><a href="reference/calibrate_monthly_weights.html">calibrate_monthly_weights()</a></code></td>
<td>Legacy monthly calibration (use <code><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code> instead)</td>
</tr></tbody></table></div>
</div>
<div class="section level2">
<h2 id="crosswalk-structure">Crosswalk Structure<a class="anchor" aria-label="anchor" href="#crosswalk-structure"></a></h2>
<p>The crosswalk is a <code>data.table</code> at household-quarter level:</p>
<table class="table"><colgroup><col width="29%"><col width="22%"><col width="48%"></colgroup><thead><tr><th>Column</th>
<th>Type</th>
<th>Description</th>
</tr></thead><tbody><tr><td><code>Ano</code></td>
<td>integer</td>
<td>Survey year</td>
</tr><tr><td><code>Trimestre</code></td>
<td>integer</td>
<td>Quarter (1-4)</td>
</tr><tr><td><code>UPA</code></td>
<td>integer</td>
<td>Primary sampling unit</td>
</tr><tr><td><code>V1008</code></td>
<td>integer</td>
<td>Household sequence</td>
</tr><tr><td><code>V1014</code></td>
<td>integer</td>
<td>Panel group (1-8)</td>
</tr><tr><td><code>ref_month</code></td>
<td>Date</td>
<td>Reference month (1st of month)</td>
</tr><tr><td><code>ref_month_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1, 2, 3) or NA</td>
</tr><tr><td><code>ref_month_yyyymm</code></td>
<td>integer</td>
<td>YYYYMM format</td>
</tr><tr><td><code>determined_month</code></td>
<td>logical</td>
<td>TRUE if month was determined</td>
</tr><tr><td><code>ref_fortnight</code></td>
<td>Date</td>
<td>Reference fortnight (1st or 16th)</td>
</tr><tr><td><code>ref_fortnight_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1-6) or NA</td>
</tr><tr><td><code>ref_fortnight_yyyyff</code></td>
<td>integer</td>
<td>YYYYFF format (1-24 per year)</td>
</tr><tr><td><code>determined_fortnight</code></td>
<td>logical</td>
<td>TRUE if fortnight was determined</td>
</tr><tr><td><code>ref_week</code></td>
<td>Date</td>
<td>Reference week (Monday)</td>
</tr><tr><td><code>ref_week_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1-14) or NA</td>
</tr><tr><td><code>ref_week_yyyyww</code></td>
<td>integer</td>
<td>ISO YYYYWW format</td>
</tr><tr><td><code>determined_week</code></td>
<td>logical</td>
<td>TRUE if week was determined</td>
</tr></tbody></table><p><strong>Join keys:</strong> <code>Ano</code>, <code>Trimestre</code>, <code>UPA</code>, <code>V1008</code>, <code>V1014</code></p>
</div>
<div class="section level2">
<h2 id="determination-rates">Determination Rates<a class="anchor" aria-label="anchor" href="#determination-rates"></a></h2>
<table class="table"><colgroup><col width="36%"><col width="27%"><col width="36%"></colgroup><thead><tr><th>Period</th>
<th>Rate</th>
<th>Reason</th>
</tr></thead><tbody><tr><td>Month</td>
<td>~97%</td>
<td>Aggregates at UPA-V1014 level across ALL quarters (panel design)</td>
</tr><tr><td>Fortnight</td>
<td>~2-5%</td>
<td>Cannot aggregate across quarters; within-quarter constraints only</td>
</tr><tr><td>Week</td>
<td>~1-2%</td>
<td>Cannot aggregate across quarters; within-quarter constraints only</td>
</tr></tbody></table><p><strong>Key insight:</strong> Only month identification benefits from stacking data across quarters. Fortnights and weeks are determined solely from birthday constraints within a single quarter.</p>
</div>
<div class="section level2">
<h2 id="file-structure">File Structure<a class="anchor" aria-label="anchor" href="#file-structure"></a></h2>
<pre><code>R/
├── pnadc-identify-periods.R      # Main: pnadc_identify_periods()
├── pnadc-apply-periods.R         # Main: pnadc_apply_periods()
├── identify-reference-month.R    # Core month algorithm
├── identify-reference-fortnight.R # Core fortnight algorithm
├── identify-reference-week.R     # Core week algorithm
├── calibrate-weights.R           # Legacy calibration
├── fetch-sidra-population.R      # SIDRA API for population
├── smooth-aggregates.R           # Smoothing algorithm
├── utils-dates.R                 # Fast date utilities
├── utils-validation.R            # Input validation
└── PNADCperiods-package.R        # Package docs + globalVariables</code></pre>
</div>
<div class="section level2">
<h2 id="algorithm-summary">Algorithm Summary<a class="anchor" aria-label="anchor" href="#algorithm-summary"></a></h2>
<div class="section level3">
<h3 id="month-identification-high-rate">Month Identification (High Rate)<a class="anchor" aria-label="anchor" href="#month-identification-high-rate"></a></h3>
<ol style="list-style-type: decimal"><li>Calculate valid interview Saturdays using IBGE timing rules</li>
<li>Apply birthday constraints to narrow date range per person</li>
<li>Convert dates to month positions (1, 2, 3 in quarter)</li>
<li>
<strong>Aggregate at UPA-V1014 level ACROSS ALL QUARTERS</strong> (key optimization)</li>
<li>Dynamic exception detection for edge cases</li>
<li>Determine: if min_position == max_position → determined</li>
</ol></div>
<div class="section level3">
<h3 id="fortnightweek-identification-low-rate">Fortnight/Week Identification (Low Rate)<a class="anchor" aria-label="anchor" href="#fortnightweek-identification-low-rate"></a></h3>
<ol style="list-style-type: decimal"><li>Same steps 1-3 as month</li>
<li><strong>Aggregate at household level WITHIN QUARTER ONLY</strong></li>
<li>No cross-quarter aggregation (positions not consistent across visits)</li>
<li>Determine: if min_position == max_position → determined</li>
</ol></div>
</div>
<div class="section level2">
<h2 id="calibration-pipeline">Calibration Pipeline<a class="anchor" aria-label="anchor" href="#calibration-pipeline"></a></h2>
<p>When <code>pnadc_apply_periods(..., calibrate = TRUE)</code>:</p>
<ol style="list-style-type: decimal"><li>Join data with crosswalk</li>
<li>Fetch population targets from SIDRA (or use provided targets)</li>
<li>Create hierarchical calibration cells (4 levels)</li>
<li>Iterative reweighting within anchor period (quarter or year)</li>
<li>Calibrate to external population totals</li>
<li>Smooth weights (optional)</li>
</ol><p><strong>Anchor types:</strong> - <code>anchor = "quarter"</code>: Preserve quarterly totals, redistribute to sub-periods - <code>anchor = "year"</code>: Preserve annual totals (for annual PNADC data)</p>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<p><strong>Required:</strong> - <code>data.table</code> (&gt;= 1.14.0) - Core data manipulation - <code>checkmate</code> (&gt;= 2.0.0) - Input validation</p>
<p><strong>Suggested:</strong> - <code>sidrar</code> - SIDRA API access for population data - <code>testthat</code> - Testing - <code>knitr</code>, <code>rmarkdown</code> - Vignettes - <code>pkgdown</code> - Website</p>
</div>
<div class="section level2">
<h2 id="workflow-examples">Workflow Examples<a class="anchor" aria-label="anchor" href="#workflow-examples"></a></h2>
<div class="section level3">
<h3 id="standard-monthly-analysis">Standard Monthly Analysis<a class="anchor" aria-label="anchor" href="#standard-monthly-analysis"></a></h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_2023</span>, <span class="va">crosswalk</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="annual-data">Annual Data<a class="anchor" aria-label="anchor" href="#annual-data"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_annual</span>, <span class="va">crosswalk</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1032"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="crosswalk-only-no-calibration">Crosswalk Only (No Calibration)<a class="anchor" aria-label="anchor" href="#crosswalk-only-no-calibration"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_2023</span>, <span class="va">crosswalk</span>,</span>
<span>                              calibrate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-5449-6787" class="external-link">Marcos Hecksher</a>, <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

