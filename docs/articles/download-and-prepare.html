<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Download and Prepare PNADC Data • mensalizePNADC</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Download and Prepare PNADC Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mensalizePNADC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="../articles/applied-examples.html">Applied Examples</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/mensalizePNADC/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Download and Prepare PNADC Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/mensalizePNADC/blob/HEAD/vignettes/download-and-prepare.Rmd" class="external-link"><code>vignettes/download-and-prepare.Rmd</code></a></small>
      <div class="d-none name"><code>download-and-prepare.Rmd</code></div>
    </div>

    
    
<!--
MAINTAINER NOTE:
This vignette uses eval=FALSE for all code chunks.
Pre-computed outputs are shown as text blocks.

The determination rate figure is generated separately and stored in:
  mensalizePNADC/vignettes/figures/download-and-prepare/
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides a complete, step-by-step workflow for
downloading Brazil’s quarterly PNADC (Pesquisa Nacional por Amostra de
Domicilios Continua) survey data and preparing it for mensalization. By
the end, you will have monthly reference months identified for each
survey observation and optionally computed monthly survey weights.</p>
<p>The workflow covers three main tasks:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Downloading</strong> quarterly PNADC microdata from IBGE
using the <code>PNADcIBGE</code> package</li>
<li>
<strong>Stacking</strong> multiple quarters into a single dataset
(critical for high determination rates)</li>
<li>
<strong>Applying mensalization</strong> using the
<code>mensalizePNADC</code> package</li>
</ol>
<p>This vignette is intended as the “first step” for users new to
working with mensalized PNADC data. For details on the mensalization
algorithm, see <code><a href="../articles/getting-started.html">vignette("getting-started")</a></code>. For examples of
labor market analysis with mensalized data, see
<code><a href="../articles/applied-examples.html">vignette("applied-examples")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<div class="section level3">
<h3 id="required-packages">Required Packages<a class="anchor" aria-label="anchor" href="#required-packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install packages if needed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PNADcIBGE"</span>, <span class="st">"tidyverse"</span>, <span class="st">"fst"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install mensalizePNADC from GitHub</span></span>
<span><span class="co"># install.packages("remotes")</span></span>
<span><span class="co"># remotes::install_github("antrologos/mensalizePNADC")</span></span>
<span></span>
<span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PNADcIBGE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org" class="external-link">fst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://antrologos.github.io/mensalizePNADC/">mensalizePNADC</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="system-requirements">System Requirements<a class="anchor" aria-label="anchor" href="#system-requirements"></a>
</h3>
<ul>
<li>
<strong>Disk space</strong>: ~5 GB for 2020-2024 data, ~15 GB for
full history (2012-present)</li>
<li>
<strong>RAM</strong>: At least 8 GB recommended; 16 GB for
comfortable processing</li>
<li>
<strong>Time</strong>: 2-3 hours for downloading (depends on
internet speed), ~5 minutes for processing</li>
<li>
<strong>Internet</strong>: Required for downloading data and for
SIDRA API access (weight calibration)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="understanding-pnadc-data">Understanding PNADC Data<a class="anchor" aria-label="anchor" href="#understanding-pnadc-data"></a>
</h2>
<p>PNADC is Brazil’s primary household survey for labor market
statistics, conducted by IBGE. The survey uses a rotating panel design
where each household is interviewed five times over 15 months. Each
quarterly release contains approximately 500,000 observations.</p>
<p><strong>Why stack multiple quarters?</strong> The mensalization
algorithm identifies reference months by tracking households across
their panel interviews. With a single quarter, the determination rate is
only ~65-75%. By stacking multiple quarters, the algorithm can leverage
the rotating panel structure to achieve a <strong>97% determination
rate</strong>.</p>
<p>The figure below shows how determination rate improves as more
quarters are stacked:</p>
<div class="float">
<img src="figures/download-and-prepare/fig-determination-rate.png" style="width:100.0%" alt="Determination rate improves with more stacked quarters"><div class="figcaption">Determination rate improves with more stacked
quarters</div>
</div>
<p>For most applications, we recommend stacking at least 2-3 years of
data to achieve optimal results.</p>
</div>
<div class="section level2">
<h2 id="step-1-set-up-your-environment">Step 1: Set Up Your Environment<a class="anchor" aria-label="anchor" href="#step-1-set-up-your-environment"></a>
</h2>
<p>First, create a directory to store the downloaded data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set your data directory (adjust path as needed)</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="st">"path/to/your/pnadc_data/"</span></span>
<span></span>
<span><span class="co"># Create directory if it doesn't exist</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">data_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-define-which-quarters-to-download">Step 2: Define Which Quarters to Download<a class="anchor" aria-label="anchor" href="#step-2-define-which-quarters-to-download"></a>
</h2>
<p>Create a grid of year-quarter combinations to download. This example
uses 2020-2024, which provides a good balance between data size and
determination rate:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define quarters to download (2020-2024 example)</span></span>
<span><span class="va">editions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fl">2020</span><span class="op">:</span><span class="fl">2024</span>,</span>
<span>  quarter <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Remove quarters not yet available</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2024</span> <span class="op">&amp;</span> <span class="va">quarter</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the grid</span></span>
<span><span class="va">editions</span></span></code></pre></div>
<p>This creates a grid of 19 quarters. Adjust the filter for the most
recent available quarter.</p>
</div>
<div class="section level2">
<h2 id="step-3-download-the-data">Step 3: Download the Data<a class="anchor" aria-label="anchor" href="#step-3-download-the-data"></a>
</h2>
<p>The download loop fetches each quarter from IBGE and saves it in FST
format for fast loading later:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download and save each quarter</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">editions</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">year_i</span> <span class="op">&lt;-</span> <span class="va">editions</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">quarter_i</span> <span class="op">&lt;-</span> <span class="va">editions</span><span class="op">$</span><span class="va">quarter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"pnadc_"</span>, <span class="va">year_i</span>, <span class="st">"-"</span>, <span class="va">quarter_i</span>, <span class="st">"q.fst"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Downloading:"</span>, <span class="va">year_i</span>, <span class="st">"Q"</span>, <span class="va">quarter_i</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Download from IBGE</span></span>
<span>  <span class="va">pnadc_quarter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PNADcIBGE/man/get_pnadc.html" class="external-link">get_pnadc</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="va">year_i</span>,</span>
<span>    quarter <span class="op">=</span> <span class="va">quarter_i</span>,</span>
<span>    labels <span class="op">=</span> <span class="cn">FALSE</span>,    <span class="co"># IMPORTANT: Use numeric codes, not labels</span></span>
<span>    deflator <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    design <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    savedir <span class="op">=</span> <span class="va">data_dir</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save as FST format (fast serialization)</span></span>
<span>  <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">write_fst</a></span><span class="op">(</span><span class="va">pnadc_quarter</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="va">filename</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Clean up temporary files created by PNADcIBGE</span></span>
<span>  <span class="va">temp_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">data_dir</span>,</span>
<span>                           pattern <span class="op">=</span> <span class="st">"\\.(zip|sas|txt)$"</span>,</span>
<span>                           full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">temp_files</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Free memory</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">pnadc_quarter</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<blockquote>
<p><strong>Important</strong>: Always use <code>labels = FALSE</code>
when downloading. The mensalization algorithm requires numeric codes for
the birthday variables (V2008, V20081, V20082). Using labeled factors
will cause errors.</p>
</blockquote>
<p>This loop will take 2-3 hours depending on your internet connection.
Each quarter is approximately 300-400 MB when saved as FST.</p>
</div>
<div class="section level2">
<h2 id="step-4-stack-the-quarterly-files">Step 4: Stack the Quarterly Files<a class="anchor" aria-label="anchor" href="#step-4-stack-the-quarterly-files"></a>
</h2>
<p>Now stack all the quarterly files into a single dataset. To save
memory, we only load the columns needed for mensalization:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Columns needed for mensalization</span></span>
<span><span class="va">cols_needed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="co"># Time and identifiers</span></span>
<span>  <span class="st">"Ano"</span>, <span class="st">"Trimestre"</span>, <span class="st">"UPA"</span>, <span class="st">"V1008"</span>, <span class="st">"V1014"</span>, <span class="st">"V2003"</span>,</span>
<span>  <span class="co"># Birthday variables (for reference month algorithm)</span></span>
<span>  <span class="st">"V2008"</span>, <span class="st">"V20081"</span>, <span class="st">"V20082"</span>, <span class="st">"V2009"</span>,</span>
<span>  <span class="co"># Weight and stratification (for weight calibration)</span></span>
<span>  <span class="st">"V1028"</span>, <span class="st">"UF"</span>, <span class="st">"posest"</span>, <span class="st">"posest_sxi"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stack all quarters</span></span>
<span><span class="va">pnadc_stacked</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">editions</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">year_i</span> <span class="op">&lt;-</span> <span class="va">editions</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">quarter_i</span> <span class="op">&lt;-</span> <span class="va">editions</span><span class="op">$</span><span class="va">quarter</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"pnadc_"</span>, <span class="va">year_i</span>, <span class="st">"-"</span>, <span class="va">quarter_i</span>, <span class="st">"q.fst"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Loading:"</span>, <span class="va">filename</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Read only the columns we need (saves memory)</span></span>
<span>  <span class="va">quarter_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read_fst</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="va">filename</span><span class="op">)</span>,</span>
<span>    columns <span class="op">=</span> <span class="va">cols_needed</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">pnadc_stacked</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, <span class="va">quarter_data</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">quarter_data</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total observations:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pnadc_stacked</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>Loading: pnadc_2020-1q.fst
Loading: pnadc_2020-2q.fst
...
Loading: pnadc_2024-3q.fst
Total observations: 10,847,562</code></pre>
</div>
<div class="section level2">
<h2 id="step-5-apply-mensalization">Step 5: Apply Mensalization<a class="anchor" aria-label="anchor" href="#step-5-apply-mensalization"></a>
</h2>
<p>Now apply the mensalization algorithm. Setting
<code>compute_weights = TRUE</code> also generates monthly survey
weights:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply mensalization with monthly weight computation</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mensalizePNADC.html">mensalizePNADC</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pnadc_stacked</span>,</span>
<span>  compute_weights <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the determination rate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Determination rate:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f%%"</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"determination_rate"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>Validating input data...
Identifying reference months...
Computing monthly weights...
Fetching monthly population from SIDRA...
Calibrating weights...

Determination rate: 97.0%</code></pre>
<p>The determination rate tells you what percentage of observations have
their reference month identified. With 19 quarters stacked, you should
achieve approximately 97%.</p>
</div>
<div class="section level2">
<h2 id="step-6-explore-the-results">Step 6: Explore the Results<a class="anchor" aria-label="anchor" href="#step-6-explore-the-results"></a>
</h2>
<p>The result is a data.table with several new columns:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View the result structure</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary of reference month distribution</span></span>
<span><span class="va">result</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">ref_month_in_quarter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pct <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code># A tibble: 4 x 3
  ref_month_in_quarter       n   pct
                 &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;
1                    1 3516234  32.4
2                    2 3498721  32.3
3                    3 3508234  32.3
4                   NA  324373   3.0</code></pre>
<p>The output columns include:</p>
<table class="table">
<colgroup>
<col width="38%">
<col width="61%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>ref_month</code></td>
<td>Reference month as Date (first day of month)</td>
</tr>
<tr class="even">
<td><code>ref_month_in_quarter</code></td>
<td>Position within quarter (1, 2, or 3)</td>
</tr>
<tr class="odd">
<td><code>ref_month_yyyymm</code></td>
<td>Reference month as YYYYMM integer</td>
</tr>
<tr class="even">
<td><code>weight_monthly</code></td>
<td>Monthly survey weight (if <code>compute_weights = TRUE</code>)</td>
</tr>
</tbody>
</table>
<p>Observations with <code>ref_month_in_quarter = NA</code> have
indeterminate reference months and should be excluded from monthly
analyses.</p>
</div>
<div class="section level2">
<h2 id="step-7-save-and-use-the-results">Step 7: Save and Use the Results<a class="anchor" aria-label="anchor" href="#step-7-save-and-use-the-results"></a>
</h2>
<p>Save the mensalized data for future use:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save the mensalized crosswalk</span></span>
<span><span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">write_fst</a></span><span class="op">(</span><span class="va">result</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"pnadc_mensalized.fst"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To use the results in analysis, join the mensalization crosswalk with
your full PNADC data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load a quarterly file with all variables</span></span>
<span><span class="va">full_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read_fst</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"pnadc_2023-1q.fst"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join with mensalization results</span></span>
<span><span class="va">analysis_data</span> <span class="op">&lt;-</span> <span class="va">full_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">result</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Ano</span>, <span class="va">Trimestre</span>, <span class="va">UPA</span>, <span class="va">V1008</span>, <span class="va">V1014</span>, <span class="va">V2003</span>,</span>
<span>                     <span class="va">ref_month</span>, <span class="va">ref_month_in_quarter</span>, <span class="va">weight_monthly</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ano"</span>, <span class="st">"Trimestre"</span>, <span class="st">"UPA"</span>, <span class="st">"V1008"</span>, <span class="st">"V1014"</span>, <span class="st">"V2003"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Now you can aggregate by month using weight_monthly</span></span>
<span><span class="va">monthly_unemployment</span> <span class="op">&lt;-</span> <span class="va">analysis_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">ref_month_in_quarter</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">ref_month</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    unemployment_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">VD4002</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">weight_monthly</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">weight_monthly</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="memory-and-performance-tips">Memory and Performance Tips<a class="anchor" aria-label="anchor" href="#memory-and-performance-tips"></a>
</h2>
<p>Working with PNADC microdata can be memory-intensive. Here are some
tips:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Selective column loading</strong>: Only load the columns
you need with <code>read_fst(..., columns = ...)</code>. This
dramatically reduces memory usage.</p></li>
<li><p><strong>Process in batches</strong>: For very large analyses,
process one year at a time and combine results.</p></li>
<li><p><strong>Use FST format</strong>: FST is much faster than CSV or
RDS for large datasets. A typical quarter loads in seconds rather than
minutes.</p></li>
<li><p><strong>Clean up regularly</strong>: Use <code><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm()</a></code> and
<code><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc()</a></code> to free memory after processing each quarter.</p></li>
</ol>
<div class="section level3">
<h3 id="file-size-reference">File Size Reference<a class="anchor" aria-label="anchor" href="#file-size-reference"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Period</th>
<th>Quarters</th>
<th>Observations</th>
<th>FST Size</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>2020-2024</td>
<td>19</td>
<td>~10.8M</td>
<td>~5 GB</td>
</tr>
<tr class="even">
<td>2012-2024</td>
<td>51</td>
<td>~28.4M</td>
<td>~15 GB</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="extending-to-full-history">Extending to Full History<a class="anchor" aria-label="anchor" href="#extending-to-full-history"></a>
</h2>
<p>For the best determination rate and longitudinal analysis, download
all available quarters:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download all available data (2012-present)</span></span>
<span><span class="va">editions_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2025</span>,</span>
<span>  quarter <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2025</span> <span class="op">&amp;</span> <span class="va">quarter</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Adjust for latest available</span></span>
<span></span>
<span><span class="co"># Use the same download and stacking loops as above</span></span></code></pre></div>
<p>The full history provides approximately 28 million observations and
achieves the highest possible determination rate.</p>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="common-issues">Common Issues<a class="anchor" aria-label="anchor" href="#common-issues"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p><strong>“Column not found” errors</strong>: Ensure you used
<code>labels = FALSE</code> when downloading. The algorithm requires
numeric codes.</p></li>
<li><p><strong>Download failures</strong>: IBGE servers can be slow or
unavailable. The <code>PNADcIBGE</code> package will retry
automatically, but you may need to restart interrupted
downloads.</p></li>
<li><p><strong>Memory errors</strong>: Try processing fewer quarters at
a time, or use a machine with more RAM.</p></li>
<li><p><strong>SIDRA API errors</strong>: The weight calibration
requires internet access to the SIDRA API. If it fails, try again later
or use <code>compute_weights = FALSE</code> for just reference month
identification.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>Now that you have mensalized PNADC data, you can:</p>
<ul>
<li>Learn about the algorithm in
<code><a href="../articles/getting-started.html">vignette("getting-started")</a></code>
</li>
<li>See analysis examples in
<code><a href="../articles/applied-examples.html">vignette("applied-examples")</a></code>
</li>
<li>Visit the <a href="https://antrologos.github.io/mensalizePNADC/">package website</a>
for more resources</li>
</ul>
<p>For questions or issues, please open an issue on <a href="https://github.com/antrologos/mensalizePNADC/issues" class="external-link">GitHub</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-5449-6787" class="external-link">Marcos Hecksher</a>, <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
