<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Apply Reference Period Crosswalk to PNADC Data — pnadc_apply_periods • PNADCperiods</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Apply Reference Period Crosswalk to PNADC Data — pnadc_apply_periods"><meta name="description" content="This function takes a crosswalk from pnadc_identify_periods and
applies it to any PNADC dataset (quarterly or annual). It can optionally
calibrate the survey weights to match external population totals at the
chosen temporal granularity (month, fortnight, or week)."><meta property="og:description" content="This function takes a crosswalk from pnadc_identify_periods and
applies it to any PNADC dataset (quarterly or annual). It can optionally
calibrate the survey weights to match external population totals at the
chosen temporal granularity (month, fortnight, or week)."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PNADCperiods</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="../articles/applied-examples.html">Applied Examples</a></li>
    <li><a class="dropdown-item" href="../articles/annual-poverty-analysis.html">Annual Poverty Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/complex-survey-design.html">Complex Survey Design</a></li>
    <li><a class="dropdown-item" href="../articles/how-it-works.html">How PNADCperiods Works</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/determination-rates-benchmark.html">Benchmark Report</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/PNADCperiods/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Apply Reference Period Crosswalk to PNADC Data</h1>
      <small class="dont-index">Source: <a href="https://github.com/antrologos/PNADCperiods/blob/HEAD/R/pnadc-apply-periods.R" class="external-link"><code>R/pnadc-apply-periods.R</code></a></small>
      <div class="d-none name"><code>pnadc_apply_periods.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function takes a crosswalk from <code><a href="pnadc_identify_periods.html">pnadc_identify_periods</a></code> and
applies it to any PNADC dataset (quarterly or annual). It can optionally
calibrate the survey weights to match external population totals at the
chosen temporal granularity (month, fortnight, or week).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pnadc_apply_periods</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">crosswalk</span>,</span>
<span>  <span class="va">weight_var</span>,</span>
<span>  <span class="va">anchor</span>,</span>
<span>  calibrate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  calibration_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"month"</span>, <span class="st">"fortnight"</span>, <span class="st">"week"</span><span class="op">)</span>,</span>
<span>  target_totals <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  keep_all <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A data.frame or data.table with PNADC microdata. Must contain
join keys <code>UPA</code> and <code>V1014</code> to merge with the crosswalk.</p></dd>


<dt id="arg-crosswalk">crosswalk<a class="anchor" aria-label="anchor" href="#arg-crosswalk"></a></dt>
<dd><p>A data.table crosswalk from <code><a href="pnadc_identify_periods.html">pnadc_identify_periods</a></code>.</p></dd>


<dt id="arg-weight-var">weight_var<a class="anchor" aria-label="anchor" href="#arg-weight-var"></a></dt>
<dd><p>Character. Name of the survey weight column. Must be specified:</p><ul><li><p><code>"V1028"</code> for quarterly PNADC data</p></li>
<li><p><code>"V1032"</code> for annual PNADC data (visit-specific or annual releases organized by quarters)</p></li>
</ul></dd>


<dt id="arg-anchor">anchor<a class="anchor" aria-label="anchor" href="#arg-anchor"></a></dt>
<dd><p>Character. How to anchor the weight redistribution. Must be specified:</p><ul><li><p><code>"quarter"</code> for quarterly data or annual releases organized by quarters (preserves quarterly totals)</p></li>
<li><p><code>"year"</code> for annual visit-specific data (preserves yearly totals)</p></li>
</ul></dd>


<dt id="arg-calibrate">calibrate<a class="anchor" aria-label="anchor" href="#arg-calibrate"></a></dt>
<dd><p>Logical. If TRUE (default), calibrate weights to external
population totals. If FALSE, only merge the crosswalk without calibration.</p></dd>


<dt id="arg-calibration-unit">calibration_unit<a class="anchor" aria-label="anchor" href="#arg-calibration-unit"></a></dt>
<dd><p>Character. Temporal unit for weight calibration.
One of <code>"month"</code> (default), <code>"fortnight"</code>, or <code>"week"</code>.</p></dd>


<dt id="arg-target-totals">target_totals<a class="anchor" aria-label="anchor" href="#arg-target-totals"></a></dt>
<dd><p>Optional data.table with population targets. If NULL
(default), fetches monthly population from SIDRA and derives targets for
fortnight/week. Each time period (month, fortnight, or week) is calibrated
to the FULL Brazilian population from SIDRA.</p>
<p>If providing custom targets, the population column (<code>m_populacao</code> for
months, <code>f_populacao</code> for fortnights, <code>w_populacao</code> for weeks)
must be in <strong>thousands</strong>. The function multiplies by 1000 internally.</p></dd>


<dt id="arg-smooth">smooth<a class="anchor" aria-label="anchor" href="#arg-smooth"></a></dt>
<dd><p>Logical. If TRUE (default), smooth calibrated weights to
remove quarterly artifacts. Smoothing is adapted per time period:
monthly (3-period window), fortnight (7-period window), weekly (no smoothing).</p></dd>


<dt id="arg-keep-all">keep_all<a class="anchor" aria-label="anchor" href="#arg-keep-all"></a></dt>
<dd><p>Logical. If TRUE (default), keep all observations including
those with undetermined reference periods. If FALSE, drop undetermined rows.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical. If TRUE (default), print progress messages.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data.table with the input data plus:</p><dl><dt>ref_month_start, ref_month_end</dt>
<dd><p>IBGE month boundaries (Sunday/Saturday)</p></dd>

<dt>ref_fortnight_start, ref_fortnight_end</dt>
<dd><p>IBGE fortnight boundaries (Sunday/Saturday)</p></dd>

<dt>ref_week_start, ref_week_end</dt>
<dd><p>IBGE week boundaries (Sunday/Saturday)</p></dd>

<dt>ref_month_in_quarter, ref_fortnight_in_quarter, ref_week_in_quarter</dt>
<dd><p>Position within quarter (1-3, 1-6, 1-12)</p></dd>

<dt>ref_month_yyyymm, ref_fortnight_yyyyff, ref_week_yyyyww</dt>
<dd><p>Integer period codes</p></dd>

<dt>ref_month_weeks</dt>
<dd><p>Number of IBGE reference weeks in month (always 4)</p></dd>

<dt>determined_month, determined_fortnight, determined_week</dt>
<dd><p>Logical determination flags</p></dd>

<dt>weight_monthly, weight_fortnight, or weight_weekly</dt>
<dd><p>Calibrated weights (if calibrate=TRUE)</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Merges a reference period crosswalk with PNADC microdata and optionally
calibrates survey weights for sub-quarterly analysis.</p><div class="section">
<h3 id="weight-calibration">Weight Calibration<a class="anchor" aria-label="anchor" href="#weight-calibration"></a></h3>


<p>When <code>calibrate = TRUE</code>, the function performs hierarchical rake weighting:</p><ol><li><p>Groups observations by nested demographic/geographic cells</p></li>
<li><p>Iteratively adjusts weights so sub-period totals match anchor-period totals</p></li>
<li><p>Calibrates final weights against external population totals (FULL Brazilian population)</p></li>
<li><p>Optionally smooths weights to remove quarterly artifacts</p></li>
</ol></div>

<div class="section">
<h3 id="population-targets">Population Targets<a class="anchor" aria-label="anchor" href="#population-targets"></a></h3>


<p>All time periods (months, fortnights, and weeks) are calibrated to the FULL
Brazilian population from SIDRA. This means:</p><ul><li><p>Monthly weights sum to the Brazilian population for that month</p></li>
<li><p>Fortnight weights sum to the Brazilian population for the containing month</p></li>
<li><p>Weekly weights sum to the Brazilian population for the containing month</p></li>
</ul></div>

<div class="section">
<h3 id="hierarchical-raking-levels">Hierarchical Raking Levels<a class="anchor" aria-label="anchor" href="#hierarchical-raking-levels"></a></h3>


<p>The number of hierarchical cell levels is automatically adjusted based on the
calibration unit to avoid sparse cell issues:</p><ul><li><p><code>"month"</code>: 4 levels (age, region, state, post-stratum) - full hierarchy</p></li>
<li><p><code>"fortnight"</code>: 2 levels (age, region) - simplified for lower sample size</p></li>
<li><p><code>"week"</code>: 1 level (age groups only) - minimal hierarchy for sparse data</p></li>
</ul></div>

<div class="section">
<h3 id="anchor-period">Anchor Period<a class="anchor" aria-label="anchor" href="#anchor-period"></a></h3>


<p>The <code>anchor</code> parameter determines how weights are redistributed:</p><ul><li><p><code>"quarter"</code>: Quarterly totals are preserved and redistributed to months/fortnights/weeks</p></li>
<li><p><code>"year"</code>: Yearly totals are preserved and redistributed to months/fortnights/weeks</p></li>
</ul><p>Use <code>anchor = "quarter"</code> with quarterly V1028 weights, and
<code>anchor = "year"</code> with annual V1032 weights.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="pnadc_identify_periods.html">pnadc_identify_periods</a></code> to build the crosswalk</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Build crosswalk</span></span></span>
<span class="r-in"><span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Apply to quarterly data with monthly calibration</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">pnadc_apply_periods</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">pnadc_2023</span>,</span></span>
<span class="r-in"><span>  <span class="va">crosswalk</span>,</span></span>
<span class="r-in"><span>  weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span></span>
<span class="r-in"><span>  anchor <span class="op">=</span> <span class="st">"quarter"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Apply to annual data</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">pnadc_apply_periods</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">pnadc_annual</span>,</span></span>
<span class="r-in"><span>  <span class="va">crosswalk</span>,</span></span>
<span class="r-in"><span>  weight_var <span class="op">=</span> <span class="st">"V1032"</span>,</span></span>
<span class="r-in"><span>  anchor <span class="op">=</span> <span class="st">"year"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Weekly calibration</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">pnadc_apply_periods</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">pnadc_2023</span>,</span></span>
<span class="r-in"><span>  <span class="va">crosswalk</span>,</span></span>
<span class="r-in"><span>  weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span></span>
<span class="r-in"><span>  anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span></span>
<span class="r-in"><span>  calibration_unit <span class="op">=</span> <span class="st">"week"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># No calibration (just merge crosswalk)</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">pnadc_apply_periods</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">pnadc_2023</span>,</span></span>
<span class="r-in"><span>  <span class="va">crosswalk</span>,</span></span>
<span class="r-in"><span>  weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span></span>
<span class="r-in"><span>  anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span></span>
<span class="r-in"><span>  calibrate <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>, <a href="https://orcid.org/0000-0002-5449-6787" class="external-link">Marcos Hecksher</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

